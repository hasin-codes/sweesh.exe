CONTEXT: WHAT WE'RE BUILDING

We are building a desktop application using Electron.js that requires user authentication. We use Clerk for authentication on our website. The login/signup flow is ALREADY COMPLETE on our landing page.

THE PROBLEM WE'RE SOLVING:
Users first sign up/login on our website (this is done). Then they download and install our Electron desktop app. We DON'T want them to enter their email/password again in the desktop app. Instead, we want a seamless "deep link" authentication flow where:

1. User auth on step 1 of src\components\ui\onboarding-modal.tsx onboard model when app start for first time.
2. It opens their browser where they're already logged into Clerk
3. The browser page automatically redirects back to the Electron app with a JWT token
4. User is now authenticated in the desktop app (no email/password entry needed)
5. IMPORTANT: User stays logged in even after closing and reopening the app

This is called "Deep Link Authentication" or "Browser-based OAuth flow for desktop apps" - similar to how Spotify, Discord, Cursor, or Slack desktop apps handle login.

---

CURRENT STATUS: WHAT'S ALREADY DONE

‚úÖ Landing page with Clerk authentication (login/signup works)
‚úÖ Users can successfully authenticate on the website
‚úÖ Clerk is configured and working
‚úÖ Electron desktop app exists (basic setup done)

---

YOUR TASK: BUILD THE LANDING PAGE DEEP LINK HANDLER

You need to create a NEW page/route on the landing page (Next.js) that will handle the deep link authentication flow. This is SEPARATE from the existing login page.

---

DETAILED REQUIREMENTS

## 1. CREATE A NEW ROUTE/PAGE

Create a new page at one of these paths (choose what's best for Next.js structure):
- `/auth/desktop` OR
- `/desktop-auth` OR  
- `/api/auth/desktop` (if API route is better)

This page will be opened by the Electron app in the user's browser.

## 2. URL PARAMETERS THE PAGE WILL RECEIVE

The Electron app will open this URL with specific query parameters:
```
https://yourwebsite.com/auth/desktop?challenge=RANDOM_UUID&uuid=USER_UUID&mode=login
```

Parameters:
- `challenge`: A random security token generated by Electron (prevents replay attacks)
- `uuid`: A unique identifier for this auth session
- `mode`: Always "login" for now (future: could be "signup")

Your page MUST extract these parameters and validate them.

## 3. AUTHENTICATION FLOW LOGIC

Step-by-step what your page must do:

### Step A: Check if User is Logged into Clerk
```javascript
// Check if there's an active Clerk session
const { isSignedIn, getToken } = useAuth(); // or use Clerk's server-side methods

if (!isSignedIn) {
  // User is NOT logged in - redirect them to the main login page
  // After they login, redirect them BACK to this deep link page with same params
  redirect('/sign-in?redirect_url=/auth/desktop?challenge=X&uuid=Y&mode=login');
  return;
}
```

### Step B: Get Clerk JWT Token
Once you confirm user is logged in:
```javascript
// Get the JWT token from Clerk with custom template
const token = await getToken({ template: 'desktop-app-auth' });

// This token contains user info in JWT claims (userId, email, name, etc.)
```

**IMPORTANT CLERK CONFIGURATION:**

Template name: `desktop-app-auth` (or whatever you named it in Clerk dashboard)

JWKS Endpoint: `https://mighty-bulldog-76.clerk.accounts.dev/.well-known/jwks.json`

Custom Claims (already configured in Clerk):
```json
{
  "userId": "{{user.id}}",
  "email": "{{user.primary_email_address}}",
  "firstName": "{{user.first_name}}",
  "lastName": "{{user.last_name}}",
  "imageUrl": "{{user.image_url}}"
}
```

### Step C: Construct Deep Link URL
```javascript
// Create the deep link URL that will open the Electron app
const deepLinkUrl = `yourappname://auth/callback?token=${token}&challenge=${challenge}&uuid=${uuid}`;

// Replace "yourappname" with the actual protocol (e.g., "myapp", "electronapp", etc.)
```

**PROTOCOL NAME:** You need to decide on a protocol name (e.g., `myapp://`). This must match what's registered in the Electron app. Suggest using a short, unique name related to your app.

### Step D: Redirect to Deep Link
```javascript
// Immediately redirect the browser to the deep link
window.location.href = deepLinkUrl;

// This will trigger the OS to open your Electron app with the token
```

### Step E: Show User Feedback (Optional but Recommended)
Since the redirect happens automatically, show a brief loading/success message:
```
"‚úÖ Authentication successful! Redirecting to the desktop app..."
```

If the deep link fails (Electron not installed), show:
```
"‚ö†Ô∏è Couldn't open the desktop app. Please make sure it's installed."
[Download App Button]
```

## 4. ERROR HANDLING

Handle these error cases:

### Error 1: No Challenge Parameter
```javascript
if (!challenge || !uuid) {
  return <ErrorPage message="Invalid authentication request. Missing required parameters." />;
}
```

### Error 2: User Not Logged In
```javascript
if (!isSignedIn) {
  // Redirect to login with return URL
  redirect(`/sign-in?redirect_url=${encodeURIComponent(currentUrl)}`);
}
```

### Error 3: Token Generation Failed
```javascript
if (!token) {
  return <ErrorPage message="Failed to generate authentication token. Please try again." />;
}
```

### Error 4: Deep Link Doesn't Open (Electron Not Installed)
```javascript
// After 3 seconds, if still on the page, show fallback
setTimeout(() => {
  showMessage("Can't open the app? Make sure it's installed.");
}, 3000);
```

## 5. SECURITY CONSIDERATIONS

- ‚úÖ Validate challenge parameter exists (prevents unauthorized redirects)
- ‚úÖ Use Clerk's secure token generation (already handled by Clerk)
- ‚úÖ Token expires quickly (60 seconds as configured in Clerk)
- ‚úÖ HTTPS only (your landing page must be HTTPS)
- ‚úÖ Don't log tokens to console (security risk)

## 6. UI/UX REQUIREMENTS

Create a simple, clean page with:

**Loading State:**
```
[Spinning loader icon]
"Authenticating your account..."
"Please wait while we connect to your desktop app."
```

**Success State (auto-redirects):**
```
‚úÖ "Authentication successful!"
"Opening desktop app..."
[Auto-redirect happens here]
```

**Error State:**
```
‚ùå "Something went wrong"
[Error message]
[Try Again Button] or [Download App Button]
```

**Not Logged In State:**
```
üîê "Please log in to continue"
[Redirects to login page automatically]
```

## 7. TECHNICAL IMPLEMENTATION DETAILS

### If Using Next.js App Router (Recommended):
```
Create file: app/auth/desktop/page.tsx
Use: useSearchParams() to get URL params
Use: @clerk/nextjs hooks (useAuth, useUser)
```

### If Using Next.js Pages Router:
```
Create file: pages/auth/desktop.tsx
Use: useRouter() to get URL params
Use: @clerk/nextjs hooks (useAuth, useUser)
```

### Server-Side vs Client-Side:
- Client-side is FINE for this use case (simpler)
- Server-side is more secure but more complex
- Choose what's best for your stack

## 8. TESTING CHECKLIST

After implementation, test these scenarios:

- [ ] User logged in ‚Üí should redirect to Electron immediately
- [ ] User not logged in ‚Üí should redirect to login page, then back
- [ ] Missing challenge param ‚Üí should show error
- [ ] Electron not installed ‚Üí should show helpful message after timeout
- [ ] Token successfully includes user data (check JWT decode)

## 9. CODE STRUCTURE EXAMPLE
```typescript
// app/auth/desktop/page.tsx (or pages/auth/desktop.tsx)

'use client'; // if using App Router

import { useAuth } from '@clerk/nextjs';
import { useSearchParams, useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';

export default function DesktopAuthPage() {
  const { isSignedIn, getToken } = useAuth();
  const searchParams = useSearchParams();
  const router = useRouter();
  
  const [status, setStatus] = useState('loading'); // loading, success, error
  const [errorMessage, setErrorMessage] = useState('');
  
  useEffect(() => {
    handleAuth();
  }, [isSignedIn]);
  
  async function handleAuth() {
    // Extract params
    const challenge = searchParams.get('challenge');
    const uuid = searchParams.get('uuid');
    const mode = searchParams.get('mode');
    
    // Validation logic here...
    // Token generation here...
    // Deep link redirect here...
  }
  
  return (
    <div>
      {/* UI based on status */}
    </div>
  );
}
```

## 10. IMPORTANT NOTES

- **Protocol Name:** The deep link protocol (e.g., `myapp://`) must be decided and documented. The Electron team needs this exact protocol name.

- **Token Template:** Make sure you're using the correct Clerk template name. In Clerk dashboard, the template should be named (e.g., "desktop-app-auth") and you must use this exact name when calling `getToken()`.

- **HTTPS Required:** Your landing page MUST be on HTTPS. Deep links don't work reliably with HTTP.

- **Cross-Browser Testing:** Test on Chrome, Firefox, Safari, Edge. Deep link behavior varies slightly.

- **Mobile Handling:** Optionally detect if user is on mobile and show a message like "This authentication is for desktop app only. Please use a desktop browser."

## 11. WHAT THE ELECTRON TEAM NEEDS FROM YOU

After you complete this, document these values for the Electron developers:

1. **Deep Link URL Format:**
```
   yourapp://auth/callback?token={JWT_TOKEN}&challenge={CHALLENGE}&uuid={UUID}
```

2. **Protocol Name:** (e.g., `myapp`)

3. **Your Auth Page URL:**
```
   https://yourwebsite.com/auth/desktop
```

4. **JWT Structure:** What claims are included in the token (userId, email, etc.)

5. **Token Expiration:** How long token is valid (currently 60 seconds)

## 12. RESEARCH SUGGESTIONS

If you're unsure about implementation details, search online for:

- "Next.js deep link authentication"
- "Clerk JWT token generation Next.js"
- "Custom URL scheme redirect browser"
- "OAuth desktop app authentication flow"
- "Deep linking from web to desktop app"

Check these resources:
- Clerk documentation: https://clerk.com/docs
- Next.js documentation: https://nextjs.org/docs
- Look at how Cursor, Spotify, or Slack implement similar flows

## 13. DELIVERABLES

Please provide:

1. ‚úÖ Complete code for the new auth page/route
2. ‚úÖ Any necessary configuration files (if any)
3. ‚úÖ Documentation of the deep link URL format
4. ‚úÖ The protocol name used (e.g., `myapp://`)
5. ‚úÖ List of any environment variables needed
6. ‚úÖ Testing instructions

---

FINAL REMINDERS:

- This is a NEW page, separate from existing login
- User should NOT see a login form on this page
- Page should auto-redirect almost immediately
- Focus on error handling and user feedback
- Security: Never log tokens, always use HTTPS
- The Electron app will handle persistent storage - you just need to generate and send the token

---

START IMPLEMENTATION:

Please research if needed, then create the deep link authentication page following all the requirements above. Ask clarifying questions if anything is unclear about the Clerk setup, Next.js structure, or authentication flow.
```

---

## Additional Context to Include

**Clerk Configuration Details:**
```
JWKS Endpoint: https://mighty-bulldog-76.clerk.accounts.dev/.well-known/jwks.json
Token Lifetime: 2592000 seconds (configured in Clerk)
Template Name: desktop-app-auth (or confirm what you named it)
Custom Claims: userId, email, firstName, lastName, imageUrl